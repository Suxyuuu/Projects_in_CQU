# coding=utf-8
"""
从权限计算向量
"""
import os

def get_all_permission(permission_file_list, all_permission_file_path):
    permission_name_list = os.listdir(permission_file_list)
    permission_vector = []
    permission_file = open(all_permission_file_path+'\\'+'all_permission.txt', 'r')
    for item in permission_file:
        item = item.strip('\n')
        permission_vector.append(item)
    permission_file.close()
    permission_file = open(all_permission_file_path+'\\'+'all_permission.txt', 'a')
  
    for name in permission_name_list:
        file = open(permission_file_list+'\\'+name, 'r')
        for item in file:
            item = item.strip('\n')
            if item.split('.')[0] == 'android' and item.split('.')[1] == 'permission' and item not in permission_vector:
                permission_vector.append(item)
                
                print(item)
                permission_file.write(item+'\n')
            elif item.split('.')[0] == 'com' and item.split('.')[1] == 'android' and item not in permission_vector:
                permission_vector.append(item)
                
                print(item)
                permission_file.write(item + '\n')
        file.close()
    permission_file.close()


def get_permission_vector(permission_file_path, all_permission, vector_path,all_peimission_file_name):
    # 存放良性样本权限的文件夹路径
    file_list = os.listdir(permission_file_path)
    # 标准权限集列表
    permission_list = []
    # 标准权限集文件路径
    permission_file = open(all_permission+'\\'+all_peimission_file_name, 'r')
    # 读取标准权限集
    for line in permission_file.readlines():
        line = line.strip('\n')
        permission_list.append(line)
    print("标准权限集大小为%i" % len(permission_list))
    permission_file.close()
    for name in file_list:
        # 为每个文件构造初始权限特征向量
        single_permission = []
        flag = 0
        permission_vector = [0]*len(permission_list)
        print("文件为:%s" % name)
        file = open(permission_file_path+r'\\'+name, 'r')
        # 读取每个文件中的所有权限
        for item in file:
            item = item.strip('\n')
            single_permission.append(item)
        print("总权限数量为%i" % len(single_permission))
        file.close()

        for permission in single_permission:
            if permission in permission_list:
                flag += 1
                print("权限%i成功:%s" % (flag, permission))
                permission_vector[permission_list.index(permission)] = 1
            else:
                flag += 1
                print("权限%i不被添加:%s" % (flag, permission))
        file = open(vector_path+'\\'+name, 'a')
        for bit in permission_vector:
            file.write(str(bit) + '\n')
        file.close()
    permission_file.close()

def main():
    # 存放权限的文件夹路径
    good_permission_file_list_path = r'D:\apk\apktooltest\good_sample_permission'
    bad_permission_file_list_path = r'D:\apk\apktooltest\bad_sample_permission'
    
    # 准备存放all_permission.txt的文件夹路径，all_permission.txt好像也要自己建
    all_permission_file_path = r'D:\apk\all'
    all_peimission_file_name =r'all_permission.txt'
    
    get_all_permission(good_permission_file_list_path, all_permission_file_path)
    get_all_permission(bad_permission_file_list_path, all_permission_file_path)
    
    # 存放权限向量的文件夹路径
    good_permission_vector_path = r'D:\apk\apktooltest\good_permission_vector'
    bad_permission_vector_path = r'D:\apk\apktooltest\bad_permission_vector'
    get_permission_vector(good_permission_file_list_path, all_permission_file_path, good_permission_vector_path,all_peimission_file_name)
    get_permission_vector(bad_permission_file_list_path, all_permission_file_path, bad_permission_vector_path,all_peimission_file_name)

if __name__ == '__main__':
    main()
