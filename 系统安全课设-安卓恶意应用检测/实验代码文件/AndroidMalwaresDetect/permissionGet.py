# coding=utf-8
"""
反编译apk，获取xml，得到permission

"""
import xml.dom.minidom
import os
import subprocess
import re



# AndroidMainFest.xml文件处理
def get_permission(filename, apk_target_path, permission_path):
    file_path = apk_target_path+'\\'+filename
    file_full = apk_target_path+'\\'+filename+r'\AndroidManifest.xml'
    file_list = os.listdir(file_path)
    if 'AndroidManifest.xml' in file_list:
        if os.path.getsize(file_full)==0:
            print("xml文件为空")
        else:
            dom = xml.dom.minidom.parse(file_full)
            root = dom.documentElement
            item_list = root.getElementsByTagName('uses-permission') 
            write_file = permission_path + '\\' + filename + r'.txt'
            fp = open(write_file, 'a')
            for item in item_list:
                un = item.getAttribute("android:name")
                fp.write(un + '\n')
            fp.close()
    else:
        print(filename+"反编译失败")


# 利用 apk_tool 工具进行反编译
def apk_tool(file_path, filename, target_path, apk_tool_path):
    apk_tool_command = apk_tool_path+r' && apktool d -f '+file_path+' -o '+target_path+'\\'+filename
    return subprocess.call(apk_tool_command)


def circle_tool(file_path, target_path, apk_tool_path, permission_path): 
    file_list = []
    file_list = os.listdir(file_path)
    inv_file_list=os.listdir(target_path)
    count = 0
    for file_name in file_list:
        if file_name in inv_file_list:
            print("%s 已反编译过" % file_name)
        else:
            count += 1
            print("序号:%i %s" % (count, file_name))
            file_full_name = file_path + '\\' + file_name
            if apk_tool(file_full_name, file_name, target_path, apk_tool_path):
                get_permission(file_name, target_path, permission_path)
                continue
    


# 应该需要手动创建文件夹吧，我不清楚，哈哈
# apk tool的文件夹路径
apk_tool_folder_path = r'cd D:\apk\apktool'

# 存放permission的文件夹路径
good_permission_target_folder_path = r'D:\apk\apktooltest\good_sample_permission'
bad_permission_target_folder_path = r'D:\apk\apktooltest\bad_sample_permission'

# 存放apk源文件的文件夹路径
good_apk_source_folder_path = r'D:\apk\apktooltest\source_good'
bad_apk_source_folder_path = r'D:\apk\apktooltest\source_bad'

# 存放反编译输出的文件夹路径
good_apk_target_folder_path = r'D:\apk\apktooltest\inv_good'
bad_apk_target_folder_path = r'D:\apk\apktooltest\inv_bad'
'''
circle_tool(good_apk_source_folder_path, good_apk_target_folder_path,
            apk_tool_folder_path, good_permission_target_folder_path)
'''
circle_tool(bad_apk_source_folder_path, bad_apk_target_folder_path,
            apk_tool_folder_path, bad_permission_target_folder_path)

